name: 自动清洗节点 (Auto Clean)

on:
  workflow_dispatch:
  schedule:
    # GitHub Actions 的 cron 使用 UTC
    # UTC 22:00 = 澳门时间 06:00（UTC+8）
    - cron: "0 22 * * *"

jobs:
  run_cleaner:
    runs-on: ubuntu-latest

    # 最小权限 / Least privilege
    permissions:
      contents: read

    steps:
      - name: 1. Checkout docker branch
        uses: actions/checkout@v4
        with:
          ref: docker

      - name: 2. Start service (docker compose up)
        run: |
          docker compose up -d --build
          docker ps

      - name: 3. Wait for API ready
        run: |
          for i in {1..60}; do
            if curl -fsS http://127.0.0.1:8000/ipcheck >/dev/null; then
              echo "Service is ready"
              exit 0
            fi
            sleep 2
          done
          echo "Service not ready" >&2
          docker compose logs --no-color || true
          exit 1

      - name: 4. Generate cleaned config via /check
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          python - <<'PY'
          import os, urllib.parse, subprocess, sys
          sub = os.environ.get("SUB_URL", "").strip()
          if not sub:
            print("ERROR: secrets.SUB_URL is empty. Please set SUB_URL in Settings -> Secrets and variables -> Actions.", file=sys.stderr)
            sys.exit(1)

          url = "http://127.0.0.1:8000/check?url=" + urllib.parse.quote(sub, safe="")
          subprocess.check_call(["curl", "-fsSL", url, "-o", "cleaned.yaml"])
          print("Generated cleaned.yaml")
          PY
          ls -lh cleaned.yaml

      - name: 5. Upload artifact (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: cleaned-yaml
          path: cleaned.yaml
          retention-days: 30

      - name: 6. Shutdown
        if: always()
        run: |
          docker compose down
