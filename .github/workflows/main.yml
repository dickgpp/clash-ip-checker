name: 自动清洗节点 (Auto Clean)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"   # UTC 22:00 = 澳门时间 06:00

jobs:
  run_cleaner:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: 1. Checkout docker branch
        uses: actions/checkout@v4
        with:
          ref: docker

      - name: 2. Start service (docker compose up)
        run: |
          docker compose up -d --build
          docker ps

      - name: 3. Wait for API ready
        run: |
          for i in {1..60}; do
            if curl -fsS http://127.0.0.1:8000/ipcheck >/dev/null; then
              echo "Service is ready"
              exit 0
            fi
            sleep 2
          done
          echo "Service not ready" >&2
          docker compose logs --no-color || true
          exit 1

      - name: 4. Generate cleaned config via /check
        env:
          SUB_URL: ${{ secrets.SUB_URL }}
        run: |
          python - <<'PY'
          import os, urllib.parse, subprocess
          sub = os.environ["SUB_URL"]
          url = "http://127.0.0.1:8000/check?url=" + urllib.parse.quote(sub, safe="")
          subprocess.check_call(["curl", "-fsSL", url, "-o", "cleaned.yaml"])
          print("Generated cleaned.yaml")
          PY
          ls -lh cleaned.yaml

      - name: 5. Upload to Gist
        uses: exuanbo/actions-deploy-gist@v1.1.4
        with:
          token: ${{ secrets.GIST_TOKEN }}
          enable_set_cookie: false
          file_path: cleaned.yaml
          gist_description: "Clash Cleaned Nodes (By GitHub Actions)"
          gist_file_name: nodes.yaml

      - name: 6. Shutdown
        if: always()
        run: |
          docker compose down
